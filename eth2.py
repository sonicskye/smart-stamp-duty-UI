import binascii

from web3 import Web3
from vars import provider
from utilities import quotedstr, singlequotedstr
#POA
from web3.middleware import geth_poa_middleware

web3 = Web3(Web3.HTTPProvider(provider, request_kwargs={'timeout': 60}))
#IPC provider
#web3 = Web3(Web3.IPCProvider(provider))
#POA only
#web3.middleware_stack.inject(geth_poa_middleware, layer=0)

#print(web3.eth.getBlock('latest'))

#ABI
contractAbi = '''[ { "constant": false, "inputs": [ { "name": "value", "type": "uint256" } ], "name": "burnToZeroAddress", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x03b01633" }, { "constant": false, "inputs": [ { "name": "value", "type": "uint256" } ], "name": "_burnToZeroAddress", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x0425ca14" }, { "constant": true, "inputs": [], "name": "name", "outputs": [ { "name": "", "type": "string" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x06fdde03" }, { "constant": true, "inputs": [], "name": "zeroAddress", "outputs": [ { "name": "", "type": "address" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x0930907b" }, { "constant": false, "inputs": [ { "name": "spender", "type": "address" }, { "name": "value", "type": "uint256" } ], "name": "approve", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x095ea7b3" }, { "constant": true, "inputs": [], "name": "totalSupply", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x18160ddd" }, { "constant": true, "inputs": [ { "name": "stampCode", "type": "bytes32" }, { "name": "row", "type": "uint256" } ], "name": "getPaymentOfStampAtIndex", "outputs": [ { "name": "paymentCode", "type": "bytes32" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x18c10431" }, { "constant": false, "inputs": [ { "name": "from", "type": "address" }, { "name": "to", "type": "address" }, { "name": "value", "type": "uint256" } ], "name": "transferFrom", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x23b872dd" }, { "constant": true, "inputs": [], "name": "INITIAL_SUPPLY", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x2ff2e9dc" }, { "constant": false, "inputs": [ { "name": "spender", "type": "address" }, { "name": "addedValue", "type": "uint256" } ], "name": "increaseAllowance", "outputs": [ { "name": "success", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x39509351" }, { "constant": false, "inputs": [], "name": "unpause", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x3f4ba83a" }, { "constant": false, "inputs": [ { "name": "account", "type": "address" }, { "name": "value", "type": "uint256" } ], "name": "mint", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x40c10f19" }, { "constant": false, "inputs": [ { "name": "stampCode", "type": "bytes32" }, { "name": "stampName", "type": "string" }, { "name": "stampPrice", "type": "uint32" }, { "name": "regulationReference", "type": "string" } ], "name": "createStamp", "outputs": [ { "name": "success", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x44ccdde2" }, { "constant": true, "inputs": [ { "name": "stampCode", "type": "bytes32" } ], "name": "getPaymentOfStampCount", "outputs": [ { "name": "paymentOfStampCount", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x4c2b51c7" }, { "constant": true, "inputs": [], "name": "paused", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x5c975abb" }, { "constant": false, "inputs": [ { "name": "payCode", "type": "bytes32" }, { "name": "docHash", "type": "string" }, { "name": "stampCode", "type": "bytes32" } ], "name": "createPayment", "outputs": [ { "name": "success", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x667f1437" }, { "constant": true, "inputs": [ { "name": "owner", "type": "address" } ], "name": "balanceOf", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x70a08231" }, { "constant": false, "inputs": [], "name": "renounceOwnership", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x715018a6" }, { "constant": false, "inputs": [], "name": "pause", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x8456cb59" }, { "constant": true, "inputs": [], "name": "owner", "outputs": [ { "name": "", "type": "address" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x8da5cb5b" }, { "constant": true, "inputs": [], "name": "isOwner", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x8f32d59b" }, { "constant": true, "inputs": [], "name": "symbol", "outputs": [ { "name": "", "type": "string" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x95d89b41" }, { "constant": false, "inputs": [ { "name": "spender", "type": "address" }, { "name": "subtractedValue", "type": "uint256" } ], "name": "decreaseAllowance", "outputs": [ { "name": "success", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0xa457c2d7" }, { "constant": false, "inputs": [ { "name": "to", "type": "address" }, { "name": "value", "type": "uint256" } ], "name": "transfer", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0xa9059cbb" }, { "constant": true, "inputs": [], "name": "getPaymentCount", "outputs": [ { "name": "paymentCount", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0xaf32a03f" }, { "constant": true, "inputs": [ { "name": "owner", "type": "address" }, { "name": "spender", "type": "address" } ], "name": "allowance", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0xdd62ed3e" }, { "constant": true, "inputs": [], "name": "getStampCount", "outputs": [ { "name": "stampCount", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0xef684c16" }, { "constant": true, "inputs": [ { "name": "stampCode", "type": "bytes32" } ], "name": "isStamp", "outputs": [ { "name": "isIndeed", "type": "bool" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0xf143de95" }, { "constant": false, "inputs": [ { "name": "newOwner", "type": "address" } ], "name": "transferOwnership", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0xf2fde38b" }, { "constant": true, "inputs": [ { "name": "payCode", "type": "bytes32" } ], "name": "isPayment", "outputs": [ { "name": "isIndeed", "type": "bool" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0xf6b1e3be" }, { "inputs": [], "payable": false, "stateMutability": "nonpayable", "type": "constructor", "signature": "constructor" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "account", "type": "address" } ], "name": "Paused", "type": "event", "signature": "0x62e78cea01bee320cd4e420270b5ea74000d11b0c9f74754ebdbfc544b05a258" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "account", "type": "address" } ], "name": "Unpaused", "type": "event", "signature": "0x5db9ee0a495bf2e6ff9c91a7834c1ba4fdd244a5e8aa4e537bd38aeae4b073aa" }, { "anonymous": false, "inputs": [ { "indexed": true, "name": "previousOwner", "type": "address" }, { "indexed": true, "name": "newOwner", "type": "address" } ], "name": "OwnershipTransferred", "type": "event", "signature": "0x8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0" }, { "anonymous": false, "inputs": [ { "indexed": true, "name": "from", "type": "address" }, { "indexed": true, "name": "to", "type": "address" }, { "indexed": false, "name": "value", "type": "uint256" } ], "name": "Transfer", "type": "event", "signature": "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef" }, { "anonymous": false, "inputs": [ { "indexed": true, "name": "owner", "type": "address" }, { "indexed": true, "name": "spender", "type": "address" }, { "indexed": false, "name": "value", "type": "uint256" } ], "name": "Approval", "type": "event", "signature": "0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925" } ]'''
contractAddress = "0x942Ce59488f858D4A35Ae1e5A15Be0888De5B28f"
#myContract = web3.eth.contract(address=contract_address, abi=contract_abi)
myContract = web3.eth.contract(address=contractAddress, abi=contractAbi)
#print(myContract.all_functions())

#call a function called balanceOf
funcName = "balanceOf"
addr = "0x06667BE53072905D1146f0Ab303D2a059c684F3a"
funcToCall = myContract.functions[funcName]
funcResult = funcToCall(addr).call()
print (funcResult)

#call a function called getStampCount
funcName = "getStampCount"
funcToCall = myContract.functions[funcName]
funcResult = funcToCall().call()
print (funcResult)

#the owner address and private key of contractAddress
privKey = "0b295aa109fcc22c6bc165fa213c952523cf1bef115483992e2afd8ccb47991e"
addr = "0x06667BE53072905D1146f0Ab303D2a059c684F3a"
contractAbi = '''[ { "constant": false, "inputs": [ { "name": "value", "type": "uint256" } ], "name": "burnToZeroAddress", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x03b01633" }, { "constant": false, "inputs": [ { "name": "value", "type": "uint256" } ], "name": "_burnToZeroAddress", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x0425ca14" }, { "constant": true, "inputs": [], "name": "name", "outputs": [ { "name": "", "type": "string" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x06fdde03" }, { "constant": true, "inputs": [], "name": "zeroAddress", "outputs": [ { "name": "", "type": "address" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x0930907b" }, { "constant": false, "inputs": [ { "name": "spender", "type": "address" }, { "name": "value", "type": "uint256" } ], "name": "approve", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x095ea7b3" }, { "constant": true, "inputs": [], "name": "totalSupply", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x18160ddd" }, { "constant": true, "inputs": [ { "name": "stampCode", "type": "bytes32" }, { "name": "row", "type": "uint256" } ], "name": "getPaymentOfStampAtIndex", "outputs": [ { "name": "paymentCode", "type": "bytes32" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x18c10431" }, { "constant": false, "inputs": [ { "name": "from", "type": "address" }, { "name": "to", "type": "address" }, { "name": "value", "type": "uint256" } ], "name": "transferFrom", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x23b872dd" }, { "constant": true, "inputs": [], "name": "INITIAL_SUPPLY", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x2ff2e9dc" }, { "constant": false, "inputs": [ { "name": "spender", "type": "address" }, { "name": "addedValue", "type": "uint256" } ], "name": "increaseAllowance", "outputs": [ { "name": "success", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x39509351" }, { "constant": false, "inputs": [], "name": "unpause", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x3f4ba83a" }, { "constant": false, "inputs": [ { "name": "account", "type": "address" }, { "name": "value", "type": "uint256" } ], "name": "mint", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x40c10f19" }, { "constant": false, "inputs": [ { "name": "stampCode", "type": "bytes32" }, { "name": "stampName", "type": "string" }, { "name": "stampPrice", "type": "uint32" }, { "name": "regulationReference", "type": "string" } ], "name": "createStamp", "outputs": [ { "name": "success", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x44ccdde2" }, { "constant": true, "inputs": [ { "name": "stampCode", "type": "bytes32" } ], "name": "getPaymentOfStampCount", "outputs": [ { "name": "paymentOfStampCount", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x4c2b51c7" }, { "constant": true, "inputs": [], "name": "paused", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x5c975abb" }, { "constant": false, "inputs": [ { "name": "payCode", "type": "bytes32" }, { "name": "docHash", "type": "string" }, { "name": "stampCode", "type": "bytes32" } ], "name": "createPayment", "outputs": [ { "name": "success", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x667f1437" }, { "constant": true, "inputs": [ { "name": "owner", "type": "address" } ], "name": "balanceOf", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x70a08231" }, { "constant": false, "inputs": [], "name": "renounceOwnership", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x715018a6" }, { "constant": false, "inputs": [], "name": "pause", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0x8456cb59" }, { "constant": true, "inputs": [], "name": "owner", "outputs": [ { "name": "", "type": "address" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x8da5cb5b" }, { "constant": true, "inputs": [], "name": "isOwner", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x8f32d59b" }, { "constant": true, "inputs": [], "name": "symbol", "outputs": [ { "name": "", "type": "string" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0x95d89b41" }, { "constant": false, "inputs": [ { "name": "spender", "type": "address" }, { "name": "subtractedValue", "type": "uint256" } ], "name": "decreaseAllowance", "outputs": [ { "name": "success", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0xa457c2d7" }, { "constant": false, "inputs": [ { "name": "to", "type": "address" }, { "name": "value", "type": "uint256" } ], "name": "transfer", "outputs": [ { "name": "", "type": "bool" } ], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0xa9059cbb" }, { "constant": true, "inputs": [], "name": "getPaymentCount", "outputs": [ { "name": "paymentCount", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0xaf32a03f" }, { "constant": true, "inputs": [ { "name": "owner", "type": "address" }, { "name": "spender", "type": "address" } ], "name": "allowance", "outputs": [ { "name": "", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0xdd62ed3e" }, { "constant": true, "inputs": [], "name": "getStampCount", "outputs": [ { "name": "stampCount", "type": "uint256" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0xef684c16" }, { "constant": true, "inputs": [ { "name": "stampCode", "type": "bytes32" } ], "name": "isStamp", "outputs": [ { "name": "isIndeed", "type": "bool" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0xf143de95" }, { "constant": false, "inputs": [ { "name": "newOwner", "type": "address" } ], "name": "transferOwnership", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function", "signature": "0xf2fde38b" }, { "constant": true, "inputs": [ { "name": "payCode", "type": "bytes32" } ], "name": "isPayment", "outputs": [ { "name": "isIndeed", "type": "bool" } ], "payable": false, "stateMutability": "view", "type": "function", "signature": "0xf6b1e3be" }, { "inputs": [], "payable": false, "stateMutability": "nonpayable", "type": "constructor", "signature": "constructor" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "account", "type": "address" } ], "name": "Paused", "type": "event", "signature": "0x62e78cea01bee320cd4e420270b5ea74000d11b0c9f74754ebdbfc544b05a258" }, { "anonymous": false, "inputs": [ { "indexed": false, "name": "account", "type": "address" } ], "name": "Unpaused", "type": "event", "signature": "0x5db9ee0a495bf2e6ff9c91a7834c1ba4fdd244a5e8aa4e537bd38aeae4b073aa" }, { "anonymous": false, "inputs": [ { "indexed": true, "name": "previousOwner", "type": "address" }, { "indexed": true, "name": "newOwner", "type": "address" } ], "name": "OwnershipTransferred", "type": "event", "signature": "0x8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0" }, { "anonymous": false, "inputs": [ { "indexed": true, "name": "from", "type": "address" }, { "indexed": true, "name": "to", "type": "address" }, { "indexed": false, "name": "value", "type": "uint256" } ], "name": "Transfer", "type": "event", "signature": "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef" }, { "anonymous": false, "inputs": [ { "indexed": true, "name": "owner", "type": "address" }, { "indexed": true, "name": "spender", "type": "address" }, { "indexed": false, "name": "value", "type": "uint256" } ], "name": "Approval", "type": "event", "signature": "0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925" } ]'''
contractAddress = "0x942Ce59488f858D4A35Ae1e5A15Be0888De5B28f"
addr2 = "0xC05D9cd3D85AEA95c4E7a5380372e76c66a8e6e0"

#create manual transaction: transfer from addr1/owner to addr2
#transfer tokens with amout of transferAmount
#based on https://web3py.readthedocs.io/en/stable/web3.eth.account.html#sign-a-contract-transaction
transferAmount = 1000
nonce = web3.eth.getTransactionCount(addr)
gasPrice = web3.toWei('1', 'gwei')
detailTx = {'chainId': 1, 'gas': 70000, 'gasPrice': gasPrice, 'nonce': nonce,}
myContract = web3.eth.contract(address=contractAddress, abi=contractAbi)
unsignedTx = myContract.functions.transfer(addr2, transferAmount).buildTransaction(detailTx)
signedTx = web3.eth.account.signTransaction(unsignedTx, private_key=privKey)
signedTxHash = binascii.hexlify(signedTx.hash)
#print (nonce)
#print (unsignedTx)
print (signedTx)
print (signedTxHash)
web3.eth.sendRawTransaction(signedTx.rawTransaction)
print(web3.toHex(web3.sha3(signedTx.rawTransaction)))

#call a function called balanceOf
#checking the destination address, should has its tokens increased
funcName = "balanceOf"
addr2 = "0xC05D9cd3D85AEA95c4E7a5380372e76c66a8e6e0"
funcToCall = myContract.functions[funcName]
funcResult = funcToCall(addr2).call()
print (funcResult)

#getPaymentOfStampAtIndex
#error
#funcName = "getPaymentOfStampAtIndex"
#stampCode = web3.toBytes(0x01)
#row = 0
#params = {'stampCode': quotedstr("0x01"), 'row': quotedstr("0")}
#params = {quotedstr("0x01"), quotedstr("0")}
#print (params)

#funcToCall = myContract.functions[funcName]
#funcResult = funcToCall().call(params)
#print (funcResult)